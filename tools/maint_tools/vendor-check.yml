# .github/workflows/vendor-check.yml
---
name: CI Vendor Check

on:
  push:
    paths:
      - 'tools/maint_tools/**'
      - '*externals/**'
  pull_request:

jobs:
  verify-vendors:
    name: "Verify Vendored Dependencies"
    runs-on: ubuntu-latest

    # To enable this workflow on a fork, comment out:
    if: github.repository == 'scikit-plots/scikit-plots'

    steps:
      ## üì• Checkout the Git repository into the runner
      - name: "‚¨áÔ∏è Checkout (cloned) repository with full history"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false  # Prevents accidental credential exposure
          # submodules: true  # Fetch Hugo themes (true OR recursive)
          fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod
          lfs: true
          ## Gets the correct commit message for pull request
          ref: ${{ github.event.pull_request.head.sha || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        continue-on-error: true
        with:
          python-version: '3.11'

      - name: Verify vendored dependencies
        if: success()
        continue-on-error: true
        run: |
          VENDOR_SH="./tools/maint_tools/vendor_repo.sh"
          VENDOR_PY="./tools/maint_tools/verify_vendor.py"

          VENDORS=(
            "./scikitplot/cexternals/_astropy"
            "./scikitplot/cexternals/NumCpp"
            "./scikitplot/externals/_seaborn"
            "./scikitplot/externals/array_api_compat"
            "./scikitplot/externals/array_api_extra"
          )

          # For each vendored folder
          for VENDOR_DIR in "${VENDORS[@]}"; do
              echo "üîç Checking $VENDOR_DIR ..."
              if ! bash "$VENDOR_SH" --target "$VENDOR_DIR" --check; then
                  echo "‚ö† Vendor hash mismatch detected, updating tree hash..."
                  bash "$VENDOR_SH" --target "$VENDOR_DIR" --update-hash
              fi

              # Human-readable verification
              python "$VENDOR_PY" "$VENDOR_DIR"
          done
